name: Terraform Plan
on:
  workflow_call:
    inputs:
      terraform_version:
        description: Terraform version to use
        default: "1.14.4"
        required: false
        type: string
      working_directory:
        description: Directory containing Terraform configuration
        default: terraform
        required: false
        type: string
      infisical_common_env:
        description: Infisical environment slug for common secrets
        default: terraform-common
        required: false
        type: string
      infisical_project_env:
        description: Infisical environment slug for project secrets (defaults to terraform-{repo-name})
        default: ""
        required: false
        type: string
      infisical_project_slug:
        description: Infisical project slug
        default: terraform
        required: false
        type: string
    secrets:
      INFISICAL_IDENTITY_ID:
        description: Infisical machine identity ID for OIDC auth
        required: true

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  plan:
    name: Plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # ratchet:hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Fetch common secrets from Infisical
        uses: Infisical/secrets-action@8802effbe453d0576cd923567dcc2c97a1f54058 # ratchet:Infisical/secrets-action@v1.0.15
        with:
          domain: https://eu.infisical.com
          method: oidc
          oidc-audience: ${{ github.server_url }}/${{ github.repository_owner }}
          env-slug: ${{ inputs.infisical_common_env }}
          project-slug: ${{ inputs.infisical_project_slug }}
          identity-id: ${{ secrets.INFISICAL_IDENTITY_ID }}
          export-type: env

      - name: Fetch project secrets from Infisical
        uses: Infisical/secrets-action@8802effbe453d0576cd923567dcc2c97a1f54058 # ratchet:Infisical/secrets-action@v1.0.15
        with:
          domain: https://eu.infisical.com
          method: oidc
          oidc-audience: ${{ github.server_url }}/${{ github.repository_owner }}
          env-slug: ${{ inputs.infisical_project_env || format('terraform-{0}', github.event.repository.name) }}
          project-slug: ${{ inputs.infisical_project_slug }}
          identity-id: ${{ secrets.INFISICAL_IDENTITY_ID }}
          export-type: env

      - name: Terraform Init
        working-directory: ${{ inputs.working_directory }}
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: ${{ inputs.working_directory }}
        run: terraform plan -no-color -out=tfplan
        continue-on-error: true

      - name: Post Plan to PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # ratchet:actions/github-script@v8
        with:
          script: |
            const { execSync } = require('child_process');
            const branch = context.ref.replace('refs/heads/', '');

            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (prs.length === 0) {
              console.log('No open PR found for this branch, skipping comment');
              return;
            }

            const prNumber = prs[0].number;
            let plan = '';
            try {
              plan = execSync(`terraform -chdir=${{ inputs.working_directory }} show -no-color tfplan`, {
                maxBuffer: 10 * 1024 * 1024
              }).toString();
            } catch (e) {
              plan = 'Failed to get plan output';
            }
            if (plan.length > 60000) plan = plan.substring(0, 60000) + '\n...(truncated)';

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes('Terraform Plan'));
            if (existing) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
              });
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `#### Terraform Plan\n\`\`\`hcl\n${plan}\n\`\`\``
            });

      - name: Exit on Plan Failure
        if: steps.plan.outcome == 'failure'
        run: exit 1
